<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EarnBDT - Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body,html{margin:0;padding:0;width:100%;height:100%;font-family:'Poppins',sans-serif;
background:linear-gradient(135deg,#87f0ff,#b0eaff,#ffbcaa,#ff7eb3,#ff758c);background-size:1200% 1200%;animation:gradientBG 25s ease infinite;overflow-x:hidden;}
@keyframes gradientBG{0%{background-position:0% 50%;}25%{background-position:50% 50%;}50%{background-position:100% 50%;}75%{background-position:50% 50%;}100%{background-position:0% 50%;}}

.container{max-width:900px;margin:40px auto;padding:20px;background:rgba(255,255,255,0.95);border-radius:25px;box-shadow:0 8px 25px rgba(0,0,0,0.2);}
h2{text-align:center;color:#ff758c;margin-bottom:20px;text-shadow:0 0 8px #fff;}
table{width:100%;border-collapse:collapse;}
th,td{padding:10px;text-align:center;border-bottom:1px solid #ccc;}
th{background:#ff758c;color:#fff;border-radius:10px;}
td button{padding:6px 12px;margin:2px;border:none;border-radius:10px;color:#fff;font-weight:600;cursor:pointer;transition:0.3s;}
td button.approve{background:#28a745;}
td button.reject{background:#dc3545;}
td button.paid{background:#007bff;}
td button:hover{transform:scale(1.05);}
.footer{text-align:center;margin:20px;color:#fff;font-size:14px;text-shadow:0 0 10px rgba(0,0,0,0.3);}
</style>
</head>
<body>

<div class="container">
<h2>Admin Panel - Withdraw Requests</h2>
<table id="requestTable">
  <thead>
    <tr>
      <th>Username</th>
      <th>Email</th>
      <th>Payment</th>
      <th>Number</th>
      <th>Amount</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <!-- Requests will be populated here -->
  </tbody>
</table>
</div>

<div class="footer">@EarnBDT - Ahyan Creations LTD</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNkACe_Drga8Uzm-mGMKKLvignadR7jN0",
  authDomain: "earnbdtapp.firebaseapp.com",
  projectId: "earnbdtapp",
  storageBucket: "earnbdtapp.firebasestorage.app",
  messagingSenderId: "407276444050",
  appId: "1:407276444050:web:b6ff2e075202716b5e094b",
  databaseURL:"https://earnbdtapp-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getDatabase();

const adminEmail = "ahyanarfinofficial@gmail.com";
const adminPassword = "9173205@KP";

// Admin login
onAuthStateChanged(auth,user=>{
  if(!user || user.email !== adminEmail){
    alert('আপনার জন্য এটি নয়!');
    auth.signOut();
    window.location.href='login.html';
  } else{
    loadRequests();
  }
});

function loadRequests(){
  const requestRef = ref(db,'withdrawRequests');
  onValue(requestRef,snapshot=>{
    const tbody = document.querySelector('#requestTable tbody');
    tbody.innerHTML = '';
    snapshot.forEach(childSnap=>{
      const data = childSnap.val();
      const key = childSnap.key;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data.username}</td>
        <td>${data.email}</td>
        <td>${data.paymentMethod}</td>
        <td>${data.number}</td>
        <td>${data.amount}</td>
        <td id="status-${key}">${data.status}</td>
        <td>
          <button class="approve" onclick="approveRequest('${key}',${data.amount},'${data.uid}')">Approve</button>
          <button class="reject" onclick="rejectRequest('${key}',${data.amount},'${data.uid}')">Reject</button>
          <button class="paid" onclick="markPaid('${key}')">Paid</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  });
}

window.approveRequest = function(key,amount,uid){
  // No need to deduct points here, already deducted on submit
  update(ref(db,'withdrawRequests/'+key),{status:"Approved"});
  alert('Request Approved!');
}

window.rejectRequest = function(key,amount,uid){
  update(ref(db,'withdrawRequests/'+key),{status:"Rejected"});
  // refund points to user
  get(ref(db,'users/'+uid)).then(snap=>{
    if(snap.exists()){
      const user = snap.val();
      const newPoints = (user.points||0) + amount;
      update(ref(db,'users/'+uid),{points:newPoints});
    }
  });
  alert('Request Rejected and points refunded!');
}

window.markPaid = function(key){
  update(ref(db,'withdrawRequests/'+key),{status:"Paid"});
  alert('Marked as Paid!');
}
</script>
</body>
</html>
