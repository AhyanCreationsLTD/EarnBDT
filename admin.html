<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EarnBDT | Admin Panel</title>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#f4f4f4;padding:20px;}
h2{text-align:center;margin-bottom:20px;}
.card{background:#fff;padding:15px;margin-bottom:15px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.2);}
.card h3{margin:0;color:#333;}
.card p{margin:5px 0;color:#555;}
.card button{padding:8px 12px;margin-right:10px;border:none;border-radius:8px;color:#fff;cursor:pointer;}
.approve{background:green;}
.reject{background:red;}
.paid{background:#667eea;}
</style>
</head>
<body>

<h2>Admin Panel - Withdraw Requests</h2>
<div id="requestsContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, get, update, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNkACe_Drga8Uzm-mGMKKLvignadR7jN0",
  authDomain: "earnbdtapp.firebaseapp.com",
  databaseURL: "https://earnbdtapp-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "earnbdtapp",
  storageBucket: "earnbdtapp.firebasestorage.app",
  messagingSenderId: "407276444050",
  appId: "1:407276444050:web:b6ff2e075202716b5e094b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

async function loadRequests(){
  const reqRef = ref(db,"withdrawals");
  const snap = await get(reqRef);
  const container = document.getElementById("requestsContainer");
  container.innerHTML="";
  if(snap.exists()){
    const allReq = snap.val();
    Object.entries(allReq).forEach(([key,req])=>{
      const div = document.createElement("div");
      div.className="card";
      div.innerHTML=`<h3>${req.username} - ${req.amount} BDT (${req.method})</h3>
                     <p>Email: ${req.email}</p>
                     <p>Number: ${req.number}</p>
                     <p>Status: ${req.status}</p>`;

      if(req.status==="Pending"){
        const approveBtn = document.createElement("button");
        approveBtn.className="approve";
        approveBtn.textContent="Approve";
        approveBtn.onclick=async ()=>{
          await update(ref(db,"withdrawals/"+key),{status:"Approved"});
          loadRequests();
        };

        const rejectBtn = document.createElement("button");
        rejectBtn.className="reject";
        rejectBtn.textContent="Reject";
        rejectBtn.onclick=async ()=>{
          await update(ref(db,"withdrawals/"+key),{status:"Rejected"});
          // Restore user balance
          const balRef = ref(db,"users/"+req.uid+"/balance");
          const balSnap = await get(balRef);
          let currentBalance = balSnap.val()||0;
          await update(balRef,{balance: currentBalance + req.amount});
          loadRequests();
        };

        const paidBtn = document.createElement("button");
        paidBtn.className="paid";
        paidBtn.textContent="Paid";
        paidBtn.onclick=async ()=>{
          await update(ref(db,"withdrawals/"+key),{status:"Paid"});
          loadRequests();
        };

        div.appendChild(approveBtn);
        div.appendChild(rejectBtn);
        div.appendChild(paidBtn);
      }

      container.appendChild(div);
    });
  }else{
    container.innerHTML="<p>No Withdraw Requests Found</p>";
  }
}

loadRequests();
</script>

</body>
</html>
