<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EarnBDT | Dashboard</title>

<style>
body{
  margin:0;
  font-family: Arial,sans-serif;
  background: linear-gradient(135deg,#43cea2,#185a9d);
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.header{
  width:90%;
  max-width:500px;
  background:#fff;
  margin-top:20px;
  padding:20px;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.2);
  text-align:center;
}

.header h2{
  margin:5px 0;
  color:#333;
}
.header p{
  margin:5px 0;
  color:#555;
}

.header button{
  padding:8px 16px;
  border:none;
  border-radius:8px;
  background:#ff5e62;
  color:#fff;
  cursor:pointer;
  margin-top:10px;
}

.card{
  width:90%;
  max-width:500px;
  background:#fff;
  margin:15px 0;
  padding:20px;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.2);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.card h3{
  margin:0;
  color:#333;
}
.card button{
  padding:8px 16px;
  border:none;
  border-radius:8px;
  background:#667eea;
  color:#fff;
  cursor:pointer;
}

.grid{
  width:90%;
  max-width:500px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:15px;
  margin-top:10px;
}

.grid button{
  padding:20px;
  border:none;
  border-radius:12px;
  background:#fff;
  color:#333;
  font-size:16px;
  cursor:pointer;
  box-shadow:0 8px 20px rgba(0,0,0,.2);
}

.footer{
  margin:30px 0 10px 0;
  color:#fff;
  font-weight:bold;
}
</style>
</head>
<body>

<div class="header">
  <h2 id="username">Username</h2>
  <p id="email">user@example.com</p>
  <button onclick="logout()">Logout</button>
</div>

<div class="card">
  <h3>Balance: <span id="balance">0</span> BDT</h3>
  <button onclick="withdraw()">Withdraw</button>
</div>

<div class="grid">
  <button onclick="watchAds()">Watch Ads</button>
  <button onclick="dailyReward()">Daily Reward</button>
  <button onclick="taskComplete()">Daily Tasks</button>
  <button onclick="window.location.href='ref.html'">Refer & Earn</button>
  <button onclick="window.location.href='history.html'">My History</button>
</div>

<div class="footer">@EarnBDT - Ahyan Creations LTD</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, get, set, update, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyDNkACe_Drga8Uzm-mGMKKLvignadR7jN0",
  authDomain: "earnbdtapp.firebaseapp.com",
  databaseURL: "https://earnbdtapp-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "earnbdtapp",
  storageBucket: "earnbdtapp.firebasestorage.app",
  messagingSenderId: "407276444050",
  appId: "1:407276444050:web:b6ff2e075202716b5e094b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* Load User Info */
onAuthStateChanged(auth, user => {
  if(user){
    const uid = user.uid;
    const userRef = ref(db,"users/"+uid);
    get(userRef).then(snapshot=>{
      if(snapshot.exists()){
        const data = snapshot.val();
        document.getElementById("username").innerText = data.username || "User";
        document.getElementById("email").innerText = data.email || user.email;
        document.getElementById("balance").innerText = data.balance || 0;
      }
    });
  }else{
    window.location.href = "login.html";
  }
});

/* Logout */
window.logout = function(){
  signOut(auth).then(()=>{
    window.location.href = "login.html";
  });
}

/* Update Balance on Page */
async function updateBalance(uid, amount){
  const balRef = ref(db,"users/"+uid+"/balance");
  const snap = await get(balRef);
  let currentBalance = snap.val() || 0;
  currentBalance += amount;
  await set(balRef,currentBalance);
  document.getElementById("balance").innerText = currentBalance;
  return currentBalance;
}

/* Watch Ads → +10 points */
window.watchAds = async function(){
  const user = auth.currentUser;
  if(!user) return alert("Login required");
  await updateBalance(user.uid,10);
  alert("আপনি 10 পয়েন্ট অর্জন করেছেন Watch Ads দেখার জন্য!");
}

/* Daily Reward → +2 points once per day */
window.dailyReward = async function(){
  const user = auth.currentUser;
  if(!user) return alert("Login required");
  const uid = user.uid;
  const today = new Date().toLocaleDateString();
  const rewardRef = ref(db,"users/"+uid+"/dailyRewardDate");
  const snap = await get(rewardRef);
  if(snap.exists() && snap.val() === today){
    alert("আপনি আজ ইতিমধ্যেই Daily Reward নিয়েছেন।");
  }else{
    await updateBalance(uid,2);
    await set(rewardRef,today);
    alert("Daily Reward 2 পয়েন্ট যোগ হয়েছে!");
  }
}

/* Daily Task → +5 points per task */
window.taskComplete = async function(){
  const user = auth.currentUser;
  if(!user) return alert("Login required");
  const uid = user.uid;
  await updateBalance(uid,5);
  alert("Task Complete! 5 পয়েন্ট যোগ হয়েছে।");
  window.location.href="task.html"; // Redirect to task page
}

/* Withdraw → only if balance >=1050 */
window.withdraw = async function(){
  const user = auth.currentUser;
  if(!user) return alert("Login required");
  const uid = user.uid;
  const balRef = ref(db,"users/"+uid+"/balance");
  const snap = await get(balRef);
  const balance = snap.val() || 0;
  if(balance < 1050){
    alert("Withdraw এর জন্য আপনার ব্যালেন্স কমপক্ষে 1050 পয়েন্ট হতে হবে!");
    return;
  }
  window.location.href="withdraw.html";
}

/* Withdraw approval/reject handled by admin */
async function adminApproveWithdraw(uid, amount){
  const balRef = ref(db,"users/"+uid+"/balance");
  const snap = await get(balRef);
  let currentBalance = snap.val() || 0;
  if(currentBalance >= amount){
    currentBalance -= amount;
    await set(balRef,currentBalance);
  }
}

async function adminRejectWithdraw(uid, amount){
  const balRef = ref(db,"users/"+uid+"/balance");
  const snap = await get(balRef);
  let currentBalance = snap.val() || 0;
  currentBalance += amount;
  await set(balRef,currentBalance);
}
</script>

</body>
</html>
